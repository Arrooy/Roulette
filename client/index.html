<style id="generalStyle"type="text/css">
body {
    overflow:hidden;
}
	::-webkit-scrollbar {
    width: 12px;
}
 
::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5); 
    border-radius: 10px;
	border-radius: 100px;

}
 
::-webkit-scrollbar-thumb {
      border-radius: 100px;
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.7); 
}

</style>

<div id="signDiv">
	Username: <input id="signDiv-username" type="text"></input><br>
	Password: <input id="signDiv-password" type="password"></input>
	<select id="signDiv-team"name="cars">
	  <option value="Team BLUE" selected>Team Blue</option>
	  <option value="Team RED">Team Red</option>
	</select>
	<button id="signDiv-signIn">Sign In</button>
	<button id="signDiv-signUp">Sign Up</button>
</div>

<div id="gameDiv" style="display:none;">
	
	<canvas id="ctx" width="500" height="500" style="position:absolute;top:1;left:1;"></canvas>
	<canvas id="ctx-ui" width="500" height="500" style="position:absolute;top:1;left:1;"></canvas>
	
	<div id="inventory" style="position:absolute;left:3px;top:3px;"></div>
	<div id="inventory2" style="position:absolute;left:3px;bottom:18px;"></div>
	
	<div id="inventory3" style="vertical-align:top;horitzontal-align:center;position:absolute;"></div>
	
	
	<div style="position:absolute;bottom:0;right:0;">
		
		<div style='overflow:hidden;background: rgba(0,0,0,0.2);'>
			<div id="chat-text" style="width:500px; max-height: 125px;overflow-y:scroll">
			</div>
		</div>
		
		<form id="chat-form"style="margin-bottom:0px" autocomplete="off">
			<input id="chat-input" type="text" style="width:500px"placeholder="This is a chat!"></input>
		</form>	 
	
	</div>
	

</div>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="/client/Inventory.js"></script>
<script>
	
	var WIDTH = document.body.clientWidth;
	var HEIGHT = document.body.clientHeight;
	var socket = io();
	
	//sign
	var signDiv = document.getElementById('signDiv');
	var signDivUsername = document.getElementById('signDiv-username');
	var signDivSignIn = document.getElementById('signDiv-signIn');
	var signDivSignUp = document.getElementById('signDiv-signUp');
	var signDivPassword = document.getElementById('signDiv-password');
	var signDivTeam = document.getElementById('signDiv-team');
	var ctx = document.getElementById("ctx").getContext("2d");
	var ctxUi = document.getElementById("ctx-ui").getContext("2d");
	//var Ui = document.getElementById("ui")
	
	var adminColor = false;
	
	signDivSignIn.onclick = function(){
		socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value,team:signDivTeam.value,width:WIDTH,height:HEIGHT});
	}
	signDivSignUp.onclick = function(){
		socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value});
	}
	socket.on('signInResponse',function(data){
		if(data.success){
			signDiv.style.display = 'none';
			gameDiv.style.display = 'inline-block';
			gameDiv.style.width = document.body.clientWidth;
			gameDiv.style.height = document.body.clientHeight;
			ctx.canvas.width = WIDTH;
			ctx.canvas.height = HEIGHT;
			ctxUi.canvas.width = WIDTH;
			ctxUi.canvas.height = HEIGHT;
			//Ui.style.width = WIDTH;
			//Ui.style.height = HEIGHT;
			
			socket.emit('HelloHeight',{width:WIDTH,height:HEIGHT});
		} else
			alert("Sign in unsuccessul.");
	});
	socket.on('signUpResponse',function(data){
		if(data.success){
			alert("Sign up successul.");
		} else
			alert("Sign up unsuccessul.");
	});

	//chat
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');
	
	socket.on('addToChat',function(data){
		if(data.admin === true){
			chatText.innerHTML += '<div id="admin" style ="color:'+data.color+'">' + data.message + '</div>';	
			adminColor = true;
		}else{
			var divisios = [];
			var numberN = 0;
			for(var i = data.message.length/40;i>=0;i--){
				chatText.innerHTML += '<div style ="color:'+data.color+'">'+data.message.slice(numberN,numberN+40) + '</div>';	
				numberN +=40;
			}		
		}
		
		chatText.scrollTop = chatText.scrollHeight;
	});
	socket.on('evalAnswer',function(data){
		console.log(data);
	});
	
	
	chatForm.onsubmit = function(e){
		e.preventDefault();
		if(chatInput.value[0] === '/'){
			socket.emit('evalServer',chatInput.value.slice(1));
		}else if(chatInput.value[0] === '@'){
			
			if(chatInput.value.indexOf(",") !== -1){
				if(chatInput.value.slice(1,chatInput.value.indexOf(',')) !== Player.list[selfId].name){
				   
					socket.emit('sendPmToServer',{
						username:chatInput.value.slice(1,chatInput.value.indexOf(',')),
						message:chatInput.value.slice(chatInput.value.indexOf(',') + 1),
					});	
				
				}else{
					chatText.innerHTML += '<div style ="color:#000000">Que solo estas...</div>';	
				}
			
				}else{
				chatText.innerHTML += '<div style ="color:#000000">Error, La sintaxis requiere @USERNAME,MESSAGE</div>';	
			}
	
		}else{
			socket.emit('sendMsgToServer',chatInput.value);	
		}
		chatInput.value = '';	
	}
	
	//UI
	
	
	
	var inventory = new Inventory(socket,false);
	
	socket.on('updateInventory',function(items){
		inventory.items = items;
		inventory.refreshRender();
	});
	
	ctx.font = '30px Arial';
	ctxUi.font = '30px Arial';
	
	
	//game
	var Img = {};
	
	Img.hgun1r = new Image();
	Img.hgun1r.src = '/client/img/6right.png';
	Img.hgun1l = new Image();
	Img.hgun1l.src = '/client/img/6left.png';
	Img.hgun1u = new Image();
	Img.hgun1u.src = '/client/img/6up.png';
	Img.hgun1d = new Image();
	Img.hgun1d.src = '/client/img/6down.png';
	
	Img.hgun2 = new Image();
	Img.hgun2.src = '/client/img/7.png';
	Img.hgun3 = new Image();
	Img.hgun3.src = '/client/img/8.png';
	Img.hNogun = new Image();
	Img.hNogun.src = '/client/img/9.png';
	
	
	Img.bulletBlau = new Image();
	Img.bulletBlau.src = '/client/img/1.png';
	Img.bulletLilaa = new Image();
	Img.bulletLilaa.src = '/client/img/2.png';
	Img.bulletOr = new Image();
	Img.bulletOr.src = '/client/img/3.png';
	Img.bulletVerd = new Image();
	Img.bulletVerd.src = '/client/img/4.png';
	Img.bulletVermell = new Image();
	Img.bulletVermell.src = '/client/img/5.png';
	Img.Zhold = new Image();
	Img.Zhold.src = '/client/img/11.png';
	
	
	

	var Player = function(initPack){
		var self = {};
		self.id = initPack.id;
		self.number = initPack.number;
		self.x = initPack.x;
		self.y = initPack.y;
		self.hp = initPack.hp;
		self.hpMax = initPack.hpMax;
		self.xp = initPack.xp;
		self.name = initPack.name;
		self.lvl = initPack.lvl;
		self.kills = initPack.kills;
		self.damage = initPack.damage;
		self.range = initPack.range;
		self.amoSize = initPack.amoSize;
		self.spd = initPack.spd;
		self.team = initPack.team;
		self.angle = initPack.angle;
		self.attackSpeed = 1;
		self.draw = function(){	
			
			var x = self.x - Player.list[selfId].x + WIDTH/2;
			var y = self.y - Player.list[selfId].y + HEIGHT/2;
					
			ctx.fillStyle = 'red';
			ctx.fillRect(x - 2.5*self.hpMax,y - 40,5*self.hpMax,5);
			ctx.fillStyle = 'green';
			ctx.fillRect(x - 2.5*self.hpMax,y - 40,5*self.hp,5);
		
			ctx.fillStyle = 'black';
			ctx.fillText(self.name + " ( "+self.team + " "+self.lvl+" )",x - 2.5*self.hpMax,y-50,100);
			
			
			if(self.angle < 0)
				self.angle = 360 + self.angle;		

			if(self.angle >= 45 && self.angle < 135){
				ctx.drawImage(Img.hgun1d,0,0,Img.hgun1d.width,Img.hgun1d.height,x-Img.hgun1d.width/2,y-Img.hgun1d.height/2,Img.hgun1d.width,Img.hgun1d.height);
			}else if(self.angle >= 135 && self.angle < 225){
				ctx.drawImage(Img.hgun1l,0,0,Img.hgun1l.width,Img.hgun1l.height,x-Img.hgun1l.width/2,y-Img.hgun1l.height/2,Img.hgun1l.width,Img.hgun1l.height);
			}else if(self.angle >= 225 && self.angle < 315){
				ctx.drawImage(Img.hgun1u,0,0,Img.hgun1u.width,Img.hgun1u.height,x-Img.hgun1u.width/2,y-Img.hgun1u.height/2,Img.hgun1u.width,Img.hgun1u.height);
			}else{
				ctx.drawImage(Img.hgun1r,0,0,Img.hgun1r.width,Img.hgun1r.height,x-Img.hgun1r.width/2,y-Img.hgun1r.height/2,Img.hgun1r.width,Img.hgun1r.height);
			}
			
			
		/*	
			switch(self.lvl){
				case 1:
				ctx.drawImage(Img.hgun1,0,0,Img.hgun1.width,Img.hgun1.height,x-Img.hgun1.width/2,y-Img.hgun1.height/2,Img.hgun1.width,Img.hgun1.height);
					break;
				case 2:
					ctx.drawImage(Img.hgun2,0,0,Img.hgun2.width,Img.hgun2.height,x-Img.hgun2.width/2,y-Img.hgun2.height/2,Img.hgun2.width,Img.hgun2.height);
					break;
				case 3:
					ctx.drawImage(Img.hgun3,0,0,Img.hgun3.width,Img.hgun3.height,x-Img.hgun3.width/2,y-Img.hgun3.height/2,Img.hgun3.width,Img.hgun3.height);
					break;
				default:ctx.drawImage(Img.hNogun,0,0,Img.hNogun.width,Img.hNogun.height,x-Img.hNogun.width/2,y-Img.hNogun.height/2,Img.hNogun.width,Img.hNogun.height);
			}*/
			
			
			if(selfId != self.id)
				return;
			var xp = self.xp;
			ctx.fillStyle = 'black';
			ctx.fillRect(0,HEIGHT - 15,WIDTH - 505,12);
			ctx.fillStyle = 'green';
			ctx.fillRect(0,HEIGHT - 15,(WIDTH - 505)*(self.xp/(10*self.lvl)),12);
		}
		
		Player.list[self.id] = self;
		
		
		return self;
	}
	Player.list = {};

	var Bullet = function(initPack){
		var self = {};
		self.id = initPack.id;
		self.x = initPack.x;
		self.y = initPack.y;
		self.lvl = initPack.lvl;
		
		self.draw = function(){	
			if(Player.list[selfId].lvl !== self.lvl)
				return;
			
			
			var x = self.x - Player.list[selfId].x + WIDTH/2;
			var y = self.y - Player.list[selfId].y + HEIGHT/2;
					
			if(Player.list[selfId].team === "Team BLUE" ){
				ctx.drawImage(Img.bulletBlau,0,0,Img.bulletBlau.width,Img.bulletBlau.height,x-Img.bulletBlau.width/2,y-Img.bulletBlau.height/2,Img.bulletBlau.width,Img.bulletBlau.height);
			}else{
				ctx.drawImage(Img.bulletVermell,0,0,Img.bulletVermell.width,Img.bulletVermell.height,x-Img.bulletVermell.width/2,y-Img.bulletVermell.height/2,Img.bulletVermell.width,Img.bulletVermell.height);
			}
			
			/*
			switch(self.lvl){
				case 1:
				ctx.drawImage(Img.bulletBlau,0,0,Img.bulletBlau.width,Img.bulletBlau.height,x-Img.bulletBlau.width/2,y-Img.bulletBlau.height/2,Img.bulletBlau.width,Img.bulletBlau.height);
					break;
				case 2:
					ctx.drawImage(Img.bulletLilaa,0,0,Img.bulletLilaa.width,Img.bulletLilaa.height,x-Img.bulletLilaa.width/2,y-Img.bulletLilaa.height/2,Img.bulletLilaa.width,Img.bulletLilaa.height);
					break;
				case 3:
					ctx.drawImage(Img.bulletOr,0,0,Img.bulletOr.width,Img.bulletOr.height,x-Img.bulletOr.width/2,y-Img.bulletOr.height/2,Img.bulletOr.width,Img.bulletOr.height);
					break;
				case 4:
					ctx.drawImage(Img.bulletVermell,0,0,Img.bulletVermell.width,Img.bulletVermell.height,x-Img.bulletVermell.width/2,y-Img.bulletVermell.height/2,Img.bulletVermell.width,Img.bulletVermell.height);
					break;
				default:ctx.drawImage(Img.bulletVerd,0,0,Img.bulletVerd.width,Img.bulletVerd.height,x-Img.bulletVerd.width/2,y-Img.bulletVerd.height/2,Img.bulletVerd.width,Img.bulletVerd.height);
			}*/
			
			
			
		}
		
		Bullet.list[self.id] = self;		
		return self;
	}


	
	
	
	
	
	
	
	
	Bullet.list = {};
	
	var selfId = null;

	socket.on('init',function(data){	
		if(data.selfId)
			selfId = data.selfId;
		//{ player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], bullet: []}
		for(var i = 0 ; i < data.player.length; i++){
			new Player(data.player[i]);
		}
		for(var i = 0 ; i < data.bullet.length; i++){
			new Bullet(data.bullet[i]);
		}
	});
	
	socket.on('update',function(data){
		//{ player : [{id:123,x:0,y:0},{id:1,x:0,y:0}], bullet: []}
		for(var i = 0 ; i < data.player.length; i++){
			var pack = data.player[i];
			var p = Player.list[pack.id];
			if(p){
				if(pack.x !== undefined)
					p.x = pack.x;
				if(pack.y !== undefined)
					p.y = pack.y;
				if(pack.hp !== undefined)
					p.hp = pack.hp;
				if(pack.xp !== undefined)
					p.xp = pack.xp;
				if(pack.lvl !== undefined)
					p.lvl = pack.lvl;
				if(pack.kills !== undefined)
					p.kills = pack.kills;
				if(pack.hpMax !== undefined)
					p.hpMax = pack.hpMax;
				
				if(pack.range !== undefined)
					p.range = pack.range;
				
				if(pack.amoSize !== undefined)
					p.amoSize = pack.amoSize;
				
				if(pack.damage !== undefined)
					p.damage = pack.damage;
				
				if(pack.spd !== undefined)
					p.spd = pack.spd;
				if(pack.team !== undefined)
					p.team = pack.team;
				if(pack.angle !== undefined)
					p.angle = pack.angle;
				
				if(pack.attackSpeed !== undefined)
					p.attackSpeed = pack.attackSpeed;
				
				
				
			}
		}
		for(var i = 0 ; i < data.bullet.length; i++){
			var pack = data.bullet[i];
			var b = Bullet.list[data.bullet[i].id];
			if(b){
				if(pack.x !== undefined)
					b.x = pack.x;
				if(pack.y !== undefined)
					b.y = pack.y;
			}
		}
	});
	
	socket.on('remove',function(data){
		//{player:[12323],bullet:[12323,123123]}
		for(var i = 0 ; i < data.player.length; i++){
			delete Player.list[data.player[i]];
		}
		for(var i = 0 ; i < data.bullet.length; i++){
			delete Bullet.list[data.bullet[i]];
		}
	});
	
	setInterval(function(){
		if(adminColor === true){
			var a  = document.getElementById('admin');
			a.style.color = '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6);			
		}
		
		if(!selfId)
			return;
		
		ctx.clearRect(0,0,WIDTH,HEIGHT);
		//drawMap();
		ui();
				
		for(var i in Player.list)
			Player.list[i].draw();
		for(var i in Bullet.list)
			Bullet.list[i].draw();
	},40);
	
	var drawMap = function(){
		var x = WIDTH/2 - Player.list[selfId].x;
		var y = HEIGHT/2 - Player.list[selfId].y;
		//Map lvl conditions here
		var anchuraMapa = 2000;
		var alturaMapa = 2000;
		ctx.drawImage(Img.bulletOr,0,0,Img.bulletOr.width,Img.bulletOr.height,x-Img.bulletOr.width/2,y-Img.bulletOr.height/2,Img.bulletOr.width,Img.bulletOr.height);
		
	}
	var lastkill = null;
	var lastxp = null;
	var lastdamage = null;
	var lasthp = null;
	var lasthpMax = null;
	var lastspd = null;
	var lastrange = null;
	var lastamoSize = null;
	var oneTime = true;
	var ui = function(){
			
		if(oneTime){
			oneTime = false;	
			ctxUi.fillStyle = 'black';
			ctxUi.fillText("Stats: ",WIDTH - 125,80,100);
		}
		
		if(lastxp !==  Player.list[selfId].xp){
			lastxp =  Player.list[selfId].xp;
			ctxUi.clearRect(WIDTH - 800,HEIGHT - 15,100,15);
			ctxUi.fillStyle = 'white';
			ctxUi.fillText(Player.list[selfId].xp + " / " + 10 * Player.list[selfId].lvl,WIDTH -800,HEIGHT - 5,50);
		}
		
		if(lastkill !== Player.list[selfId].kills){
			lastkill = Player.list[selfId].kills;		
			ctxUi.clearRect(WIDTH - 100,80,100,10);
			ctxUi.fillStyle = 'black';
			ctxUi.fillText("Kills: " +Player.list[selfId].kills,WIDTH - 100,90,100);
		}
		if(lasthp !==  Player.list[selfId].hp || lasthpMax !==  Player.list[selfId].hpMax ){
			lasthp =  Player.list[selfId].hp;
			lasthpMax =  Player.list[selfId].hpMax;
			ctxUi.clearRect(WIDTH - 100,100,100,10);
			ctxUi.fillStyle = 'black';
			ctxUi.fillText(Player.list[selfId].hp.toFixed(2) +" / "+ Player.list[selfId].hpMax+" Hp",WIDTH - 100,110,100);
		}
		if(lastdamage !==  Player.list[selfId].damage){
			lastdamage =  Player.list[selfId].damage;
			ctxUi.clearRect(WIDTH - 100,120,100,10);
			ctxUi.fillStyle = 'black';
			ctxUi.fillText("Damage: "+Player.list[selfId].damage,WIDTH-100,130,100);
		}
		if(lastspd !==  Player.list[selfId].spd){
			lastspd =  Player.list[selfId].spd;
			ctxUi.clearRect(WIDTH - 100,140,100,10);
			ctxUi.fillStyle = 'black';
			ctxUi.fillText("Speed: "+Player.list[selfId].spd,WIDTH-100,150,100);
		}
		if(lastrange !==  Player.list[selfId].range){
			lastrange =  Player.list[selfId].range;
			ctxUi.clearRect(WIDTH - 100,160,100,10);
			ctxUi.fillStyle = 'black';
			ctxUi.fillText("Range: "+Player.list[selfId].range,WIDTH-100,170,100);
		}
		if(lastamoSize !==  Player.list[selfId].amoSize){
			lastamoSize =  Player.list[selfId].amoSize;
			ctxUi.clearRect(WIDTH - 100,180,100,10);
			ctxUi.fillStyle = 'black';
			ctxUi.fillText("Amo Size "+Player.list[selfId].amoSize,WIDTH-100,190,100);
		}
		
	}
	
	
	
	document.onkeydown = function(event){
		if(document.activeElement.id !== "chat-input"){
			if(event.keyCode === 68)	//d
				socket.emit('keyPress',{inputId:'right',state:true});
			else if(event.keyCode === 83)	//s
				socket.emit('keyPress',{inputId:'down',state:true});
			else if(event.keyCode === 65) //a
				socket.emit('keyPress',{inputId:'left',state:true});
			else if(event.keyCode === 87) // w
				socket.emit('keyPress',{inputId:'up',state:true});
			else if(event.keyCode === 32) // space
				socket.emit('keyPress',{inputId:'attack',state:true});
		}
	}
	document.onkeyup = function(event){
		if(document.activeElement.id !== "chat-input"){
			if(event.keyCode === 68)	//d
				socket.emit('keyPress',{inputId:'right',state:false});
			else if(event.keyCode === 83)	//s
				socket.emit('keyPress',{inputId:'down',state:false});
			else if(event.keyCode === 65) //a
				socket.emit('keyPress',{inputId:'left',state:false});
			else if(event.keyCode === 87) // w
				socket.emit('keyPress',{inputId:'up',state:false});
			else if(event.keyCode === 32) // w
				socket.emit('keyPress',{inputId:'attack',state:false});
		}
	}
	
	document.onmousedown = function(event){
		socket.emit('keyPress',{inputId:'attack',state:true});
	}
	document.onmouseup = function(event){
		socket.emit('keyPress',{inputId:'attack',state:false});
	}
	document.onmousemove = function(event){
		var x = -WIDTH/2 + event.clientX - 8;
		var y = -HEIGHT/2 + event.clientY - 8;
		var angle = Math.atan2(y,x) / Math.PI * 180;
		socket.emit('keyPress',{inputId:'mouseAngle',state:angle});
	}
	
	document.oncontextmenu = function(event){
		event.preventDefault();
	}
	
	
	
	
</script>





